<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoU ‚Äî Classificador de E-mails</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa',
              500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95'
            }
          },
          boxShadow: {
            soft: '0 10px 30px -10px rgba(0,0,0,0.2)'
          }
        }
      },
      darkMode: 'class'
    }
  </script>

  <!-- Font & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="app-bg bg-gray-50 dark:bg-gray-950 min-h-screen">

  <!-- Top bar -->
  <header class="relative z-10 border-b border-white/60 dark:border-white/5 backdrop-blur bg-white/70 dark:bg-gray-900/60">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-brand-600 text-white grid place-content-center shadow-soft">
          <i data-lucide="mail"></i>
        </div>
        <div>
          <h1 class="text-xl font-semibold tracking-tight text-gray-900 dark:text-white">AutoU ‚Äî Classificador de E-mails</h1>
          <p class="text-xs text-gray-500 dark:text-gray-400">Cole o e-mail ou envie um .txt/.pdf para classificar e sugerir resposta</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="themeToggle" type="button" class="inline-flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200">
          <i data-lucide="moon"></i><span>Modo</span>
        </button>
      </div>
    </div>
  </header>

  <main class="relative z-10 max-w-5xl mx-auto px-4 py-8">
    <!-- Card principal -->
    <form id="emailForm" action="/process" method="post" enctype="multipart/form-data" class="bg-white dark:bg-gray-900/70 backdrop-blur rounded-2xl shadow-soft border border-white/60 dark:border-white/10 p-6">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Coluna esquerda: texto -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Texto do e-mail</label>
          <div class="relative">
            <textarea id="email_text" name="email_text" rows="10" class="w-full rounded-xl border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 p-4" placeholder="Ex.: Bom dia! Poderiam informar o andamento do chamado #12345? Preciso da previs√£o."></textarea>
            <div class="absolute bottom-2 right-3 text-xs text-gray-400" id="charCount">0 caracteres</div>
          </div>
          <!-- chips de exemplos -->
          <div class="mt-3 flex flex-wrap gap-2">
            <button type="button" data-sample="Bom dia! Poderiam informar o andamento do chamado #12345? Preciso da previs√£o." class="sample px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs hover:bg-gray-200 dark:hover:bg-gray-700">Exemplo: Status</button>
            <button type="button" data-sample="Segue anexo o documento solicitado para valida√ß√£o." class="sample px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs hover:bg-gray-200 dark:hover:bg-gray-700">Exemplo: Anexo</button>
            <button type="button" data-sample="Feliz anivers√°rio e parab√©ns pelo excelente trabalho!" class="sample px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-xs hover:bg-gray-200 dark:hover:bg-gray-700">Exemplo: Felicita√ß√µes</button>
            <button type="button" id="pasteBtn" class="px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-800 text-xs text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 inline-flex items-center gap-1"><i data-lucide="clipboard"></i>Colar da √°rea de transfer√™ncia</button>
          </div>
        </div>

        <!-- Coluna direita: upload -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Upload (.txt ou .pdf)</label>
          <div id="dropzone" class="group relative rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 hover:border-brand-400 transition p-6 grid place-content-center text-center bg-gray-50/60 dark:bg-gray-950/40">
            <div class="pointer-events-none flex flex-col items-center gap-2">
              <i data-lucide="file-up" class="text-gray-400 group-hover:text-brand-500"></i>
              <p class="text-sm text-gray-600 dark:text-gray-300">Arraste e solte aqui
                <span class="block text-xs text-gray-400">ou</span>
                <span class="text-brand-700 dark:text-brand-400 font-medium">clique para selecionar</span>
              </p>
              <p id="fileName" class="text-xs text-gray-400"></p>
            </div>
            <input id="fileInput" type="file" name="file" accept=".txt,.pdf" class="absolute inset-0 opacity-0 cursor-pointer" />
          </div>
          <p class="mt-2 text-xs text-gray-400">M√°x. 10MB. Apenas .txt e .pdf</p>

          <div class="mt-6 flex items-center gap-3">
            <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-brand-600 text-white hover:bg-brand-700 shadow">
              <i data-lucide="sparkles"></i> Processar
            </button>
            <button type="button" id="clearBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800">
              <i data-lucide="eraser"></i> Limpar
            </button>
          </div>
        </div>
      </div>

      {% if error %}
        <div class="mt-6 p-4 bg-red-50 dark:bg-red-950/40 text-red-700 dark:text-red-300 rounded-xl border border-red-200 dark:border-red-900 flex items-start gap-2">
          <i data-lucide="alert-triangle"></i>
          <div>{{ error }}</div>
        </div>
      {% endif %}
    </form>

    {% if is_multiple and multiple_emails %}
    <!-- M√∫ltiplos e-mails -->
    <section class="mt-8">
      <div class="bg-white dark:bg-gray-900/70 backdrop-blur rounded-2xl shadow-soft border border-white/60 dark:border-white/10 p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">üìß M√∫ltiplos E-mails Detectados</h2>
          <span class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 dark:bg-blue-950/40 dark:text-blue-300">
            <i data-lucide="layers"></i>{{ multiple_emails|length }} e-mails encontrados
          </span>
        </div>
        
        <div class="space-y-6">
          {% for email in multiple_emails %}
          <div class="border border-gray-200 dark:border-gray-800 rounded-xl p-5 bg-gray-50/60 dark:bg-gray-950/40">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-semibold text-gray-900 dark:text-white">{{ email.id }}</h3>
                {% if email.header %}
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ email.header }}</p>
                {% endif %}
              </div>
              <div class="flex items-center gap-3">
                <!-- Categoria -->
                {% if email.category == 'Produtivo' %}
                  <span class="inline-flex items-center gap-2 text-sm px-2.5 py-1.5 rounded-lg bg-green-50 text-green-700 dark:bg-green-950/40 dark:text-green-300">
                    <i data-lucide='check-circle'></i>{{ email.category }}
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-2 text-sm px-2.5 py-1.5 rounded-lg bg-slate-100 text-slate-700 dark:bg-slate-900 dark:text-slate-300">
                    <i data-lucide='sparkles'></i>{{ email.category }}
                  </span>
                {% endif %}
                
                <!-- Confian√ßa -->
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                  {{ "%.0f"|format(email.confidence * 100) }}%
                </span>
              </div>
            </div>
            
            <!-- Preview do conte√∫do -->
            <div class="bg-white dark:bg-gray-900 rounded-lg p-3 mb-3">
              <p class="text-sm text-gray-700 dark:text-gray-300">{{ email.content_preview }}</p>
            </div>
            
            <!-- Resposta sugerida -->
            {% if email.reply %}
            <div class="bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-3">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="message-circle" class="w-4 h-4 text-blue-600 dark:text-blue-400"></i>
                <span class="text-sm font-medium text-blue-900 dark:text-blue-100">Resposta Sugerida</span>
              </div>
              <p class="text-sm text-blue-800 dark:text-blue-200">{{ email.reply }}</p>
              <button class="mt-2 inline-flex items-center gap-1 text-xs text-blue-600 dark:text-blue-400 hover:underline copy-reply-btn" 
                      data-reply="{{ email.reply|e }}">
                <i class="w-3 h-3" data-lucide="copy"></i>
                Copiar resposta
              </button>
            </div>
            {% endif %}
            
            <!-- Informa√ß√µes adicionais -->
            <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
              <div class="flex items-center gap-4">
                {% if email.sub_intent %}
                  <span>Sub-inten√ß√£o: {{ email.sub_intent }}</span>
                {% endif %}
                {% if email.signals %}
                  <span>Sinais: {{ ', '.join(email.signals[:2]) }}{% if email.signals|length > 2 %}...{% endif %}</span>
                {% endif %}
              </div>
              
              <!-- Barra de confian√ßa -->
              <div class="flex items-center gap-2">
                <span>Confian√ßa:</span>
                <div class="w-16 h-1.5 rounded-full bg-gray-200 dark:bg-gray-700">
                  <div class="h-1.5 rounded-full bg-brand-600" data-pct="{{ (email.confidence * 100)|int }}"></div>
                </div>
              </div>
            </div>
            
            <!-- Expandir conte√∫do completo -->
            <details class="mt-3">
              <summary class="cursor-pointer text-xs text-brand-600 dark:text-brand-400 hover:underline">Ver conte√∫do completo</summary>
              <div class="mt-2 p-3 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800">
                <pre class="whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300">{{ email.content_full }}</pre>
              </div>
            </details>
          </div>
          {% endfor %}
        </div>
        
        <!-- Resumo -->
        <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-950/40 rounded-xl border border-blue-200 dark:border-blue-900">
          <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">üìä Resumo da An√°lise</h4>
          <div class="grid md:grid-cols-3 gap-4 text-sm">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600 dark:text-green-400">
                {{ multiple_emails|selectattr('category', 'equalto', 'Produtivo')|list|length }}
              </div>
              <div class="text-green-700 dark:text-green-300">Produtivos</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-600 dark:text-gray-400">
                {{ multiple_emails|selectattr('category', 'equalto', 'Improdutivo')|list|length }}
              </div>
              <div class="text-gray-700 dark:text-gray-300">Improdutivos</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
                {{ multiple_emails|length }}
              </div>
              <div class="text-blue-700 dark:text-blue-300">Total</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <details class="mt-6 bg-white dark:bg-gray-900/70 backdrop-blur rounded-2xl shadow-soft border border-white/60 dark:border-white/10 p-6">
      <summary class="cursor-pointer text-sm text-gray-600 dark:text-gray-300">Texto original completo</summary>
      <pre class="mt-3 whitespace-pre-wrap text-gray-600 dark:text-gray-300">{{ input_text }}</pre>
    </details>
    
    {% elif category %}
    <section class="mt-8 grid lg:grid-cols-3 gap-6">
      <!-- Resultado -->
      <div class="lg:col-span-1 bg-white dark:bg-gray-900/70 backdrop-blur rounded-2xl shadow-soft border border-white/60 dark:border-white/10 p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Resultado</h2>
        <dl class="grid grid-cols-2 gap-4">
          <div>
            <dt class="text-gray-500 dark:text-gray-400 text-sm">Categoria</dt>
            <dd class="mt-1">
              {% if category == 'Produtivo' %}
                <span class="inline-flex items-center gap-2 text-sm px-2.5 py-1.5 rounded-lg bg-green-50 text-green-700 dark:bg-green-950/40 dark:text-green-300"><i data-lucide='check-circle'></i>{{ category }}</span>
              {% else %}
                <span class="inline-flex items-center gap-2 text-sm px-2.5 py-1.5 rounded-lg bg-slate-100 text-slate-700 dark:bg-slate-900 dark:text-slate-300"><i data-lucide='sparkles'></i>{{ category }}</span>
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-gray-500 dark:text-gray-400 text-sm">Confian√ßa</dt>
            <dd class="mt-1 text-sm font-medium text-gray-900 dark:text-gray-100">{{ confidence }}</dd>
          </div>
          <div>
            <dt class="text-gray-500 dark:text-gray-400 text-sm">Sub-inten√ß√£o</dt>
            <dd class="mt-1 text-sm font-medium text-gray-900 dark:text-gray-100">{{ sub_intent or '‚Äî' }}</dd>
          </div>
          <div class="col-span-2">
            <dt class="text-gray-500 dark:text-gray-400 text-sm mb-2">Indicador de confian√ßa</dt>
            <div class="w-full h-2 rounded-full bg-gray-200 dark:bg-gray-800">
              <div class="h-2 rounded-full bg-brand-600" data-pct="{{ confidence|replace('%','') }}"></div>
            </div>
          </div>
        </dl>
        {% if signals %}
          <div class="mt-4 text-xs text-gray-500 dark:text-gray-400">Sinais: {{ ', '.join(signals) }}</div>
        {% endif %}
      </div>

      <!-- Resposta sugerida -->
      <div class="lg:col-span-2 bg-white dark:bg-gray-900/70 backdrop-blur rounded-2xl shadow-soft border border-white/60 dark:border-white/10 p-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Resposta sugerida</h2>
          <button id="copyBtn" type="button" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200">
            <i data-lucide="copy"></i> Copiar
          </button>
        </div>
        <pre id="replyBlock" class="whitespace-pre-wrap text-gray-800 dark:text-gray-100 bg-gray-50 dark:bg-gray-950/40 p-4 rounded-xl border border-gray-200 dark:border-gray-800">{{ reply }}</pre>
      </div>
    </section>

    <details class="mt-6 bg-white dark:bg-gray-900/70 backdrop-blur rounded-2xl shadow-soft border border-white/60 dark:border-white/10 p-6">
      <summary class="cursor-pointer text-sm text-gray-600 dark:text-gray-300">Texto analisado</summary>
      <pre class="mt-3 whitespace-pre-wrap text-gray-600 dark:text-gray-300">{{ input_text }}</pre>
    </details>
    {% endif %}
  </main>

  <!-- Loading overlay -->
  <div id="loading" class="hidden fixed inset-0 z-50 bg-white/70 dark:bg-black/50 backdrop-blur grid place-content-center">
    <div class="flex items-center gap-3 text-gray-700 dark:text-gray-200">
      <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
      Processando‚Ä¶
    </div>
  </div>

  <footer class="relative z-10 py-8 text-center text-xs text-gray-400">
    <p>AutoU ‚Ä¢ MVP de classifica√ß√£o e resposta autom√°tica de e-mails</p>
  </footer>

  <script>
    // √≠cones
    lucide.createIcons();

    // tema (dark/light)
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') html.classList.add('dark');
    themeToggle?.addEventListener('click', () => {
      html.classList.toggle('dark');
      localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
    });

    // contador de caracteres
    const ta = document.getElementById('email_text');
    const count = document.getElementById('charCount');
    const updateCount = () => { count.textContent = (ta.value.length || 0) + ' caracteres'; };
    ta?.addEventListener('input', updateCount); updateCount();

    // exemplos r√°pidos
    for (const b of document.querySelectorAll('.sample')) {
      b.addEventListener('click', () => { ta.value = b.dataset.sample; ta.focus(); updateCount(); });
    }

    // colar da √°rea de transfer√™ncia
    document.getElementById('pasteBtn')?.addEventListener('click', async () => {
      try { const txt = await navigator.clipboard.readText(); ta.value = txt; updateCount(); ta.focus(); }
      catch { alert('Permita acesso √† √°rea de transfer√™ncia para usar este recurso.'); }
    });

    // limpar formul√°rio
    document.getElementById('clearBtn')?.addEventListener('click', () => {
      // Limpa o textarea
      ta.value = '';
      
      // Limpa o input de arquivo
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.value = '';
      }
      
      // Remove o nome do arquivo exibido
      const fileName = document.getElementById('fileName');
      if (fileName) {
        fileName.textContent = '';
      }
      
      // Esconde os resultados se estiverem vis√≠veis
      const results = document.getElementById('results');
      if (results) {
        results.style.display = 'none';
      }
      
      // Atualiza o contador de caracteres
      updateCount();
      
      // Foca no textarea
      ta.focus();
    });

    // drag & drop + exibir nome do arquivo
    const dz = document.getElementById('dropzone');
    const fi = document.getElementById('fileInput');
    const fn = document.getElementById('fileName');
    fi?.addEventListener('change', () => { fn.textContent = fi.files?.[0]?.name || ''; });
    dz?.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('ring-2','ring-brand-400');});
    dz?.addEventListener('dragleave', () => dz.classList.remove('ring-2','ring-brand-400'));
    dz?.addEventListener('drop', (e) => { e.preventDefault(); dz.classList.remove('ring-2','ring-brand-400'); fi.files = e.dataTransfer.files; fn.textContent = fi.files?.[0]?.name || ''; });

    // copiar resposta
    const copyBtn = document.getElementById('copyBtn');
    copyBtn?.addEventListener('click', async () => {
      const text = document.getElementById('replyBlock')?.innerText || '';
      try { await navigator.clipboard.writeText(text); copyBtn.innerHTML = '<i data-lucide="check"></i> Copiado'; lucide.createIcons(); setTimeout(() => { copyBtn.innerHTML = '<i data-lucide="copy"></i> Copiar'; lucide.createIcons();}, 1600);} catch { alert('N√£o foi poss√≠vel copiar.'); }
    });

    // loading overlay ao enviar o form
    const form = document.getElementById('emailForm');
    form?.addEventListener('submit', () => {
      document.getElementById('loading')?.classList.remove('hidden');
    });

    // bot√µes de copiar resposta individual
    document.querySelectorAll('.copy-reply-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const reply = btn.getAttribute('data-reply');
        try {
          await navigator.clipboard.writeText(reply);
          btn.innerHTML = '<i class="w-3 h-3" data-lucide="check"></i> Copiado';
          lucide.createIcons();
          setTimeout(() => {
            btn.innerHTML = '<i class="w-3 h-3" data-lucide="copy"></i> Copiar resposta';
            lucide.createIcons();
          }, 1500);
        } catch {
          alert('N√£o foi poss√≠vel copiar a resposta.');
        }
      });
    });

    // Ajusta barras de confian√ßa (evita Jinja dentro de style inline)
    function setConfidenceBars() {
      document.querySelectorAll('[data-pct]').forEach(el => {
        const v = parseFloat(el.getAttribute('data-pct') || '0');
        el.style.width = (isFinite(v) ? v : 0) + '%';
      });
    }
    setConfidenceBars();
  </script>
</body>
</html>
